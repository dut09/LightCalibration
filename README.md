## LightCalibration ##

In this project we will try to build a non-parametric light model for a point LED light: given a 3d position in the space, the light model will return its radiance based on the distance and angle to the point light.

### settings ###

A PrimeSense + a DSLR camera + a point LED light. The PrimeSense is used to get the depth image, the DSLR is used to get RAW color image. Fix them rigidly by using a mount, industrial glue, wood, or whatever you like. The LED light has to be placed in the xoy plane in PrimeSense coordinate(i.e., z = 0). It might be helpful to read [RGBDCameraCalibration](https://github.com/dut09/RGBDCameraCalibration) first, or I assume you have already know the transformation between the two cameras.

### step 1: calibrate the light position ###

Find a flat white wall, fix your equipment from 0.5m away from that wall, take depth and color images from the PrimeSense, and a color image from the DSLR. Repeat this for different distances from the wall. **Put all the depth/color/color iamges under the folder \Position.** You can find some sample images there.

Here I will use the stereo calibration results from the project [RGBDCameraCalibration](https://github.com/dut09/RGBDCameraCalibration), so I **put the .mat file generated by stereo calibration under the root directory**. As a first step, run **init** from the root. This will update the path information and load the stereo calibration results. Then run **calib\_light\_position**, this will help you compute the center of the highlight area in each image. We will fit a line based on these centers, and trace back to z = 0, assuming it is the position of the LED light. This script will generate a .mat file called light\_info.mat, which contains the light position and light direction information in the DSLR camera frame.

### step 2: analyse the raw image ###

The next step is to understand the raw image. Robert Summer has an extremely useful [document](http://users.soe.ucsc.edu/~rcsumner/rawguide/index.html) about this. In principle, please follow this document, convert your raw images to dng images, use matlab or dcraw to decode them. We modified his matlab code and wrapped it into a function read\_dng. It will return a height by width by 3 matrix within [0, 1] range after demosaicing. The data should be linear with the actual radiance.

The by-product of this project is that we have a couple of test scripts to help make sure the data in the raw image is really what we want, and the camera settings(iso/shutter speed/aperture) is suitable for the experiment. In principle, we want to take the dng image that contains ONLY the point light radiance. To achieve this, we need to find a proper combination of camera settings that satisfy:

1. the image should be stable: if we take multiple images with exactly the same settings, the images should be almost the same(I say 'almost' because they might be noises so that we cannot expect the camera produces identical images every time).

2. the environment light should be very dark: this will relieve us from taking two images: one image with the point light, and the other image without the point light, and then we subtract them to get the real information about the image.

3. the dynamic range should be proper: note that the dynamic range of the camera is normalized into [0, 1]. If most of the sensor data is clustered in a very small dynamic range like [0, 0.2], then the relative error would be large and the data is unstable. On the other hand, if the dynamic range is too large like [0, 2.5], then we might lose too much information due to overexposure. 

Pleases **run test\_dng\_image** for this step. Before that, you can follow the comments in this script and put proper dng images under the folder /Raw for tests.

### step 3: calibrate the light radiance ###
 
In this step, we will use a purely diffuse, flat, gray board, and **take depth/color/color images from the PrimeSense and the DSLR camera with the point light on. Put all these images under the folder /Radiance, then run calib\_light\_radiance.** This script will build a light model and save it in the .mat file light\_model.mat. It is a data driven model. We first collect sample points, tabular all the samples, and do bilinear interpolation. Please refer to the comments in calib\_light\_radiance for details.

### step 4: test the light model ###



### acknowledgment and reference ###

Special thanks for Jean-Yves Bouguet's [calibration toolbox](http://www.vision.caltech.edu/bouguetj/calib_doc/).

Also, [Robert Sumner](http://users.soe.ucsc.edu/~rcsumner/index.html) has an excellent raw guide [here](http://users.soe.ucsc.edu/~rcsumner/rawguide/index.html). It is a beautiful tutorial, with very comprehensive matlab codes. We borrowed his script and made some modifications in the function read_dng.

