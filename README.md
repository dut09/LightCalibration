## LightCalibration ##

In this project we will try to build a non-parametric light model for a point LED light: given a 3d position in the space, the light model will return its radiance based on the distance and angle to the point light.

### settings ###

A PrimeSense + a DSLR camera + a point LED light. The PrimeSense is used to get the depth image, the DSLR is used to get RAW color image. Fix them rigidly by using a mount, industrial glue, wood, or whatever you like. The LED light has to be placed in the xoy plane in PrimeSense coordinate(i.e., z = 0). It might be helpful to read [RGBDCameraCalibration](https://github.com/dut09/RGBDCameraCalibration) first, or I assume you have already know the transformation between the two cameras.

### step 1: calibrate the light position ###

Find a flat white wall, fix your equipment from 0.5m away from that wall, take depth and color images from the PrimeSense, and a color image from the DSLR. Repeat this for different distances from the wall. You can refer to \Position for some sample images.

Here I will use the stereo calibration results from the project [RGBDCameraCalibration](https://github.com/dut09/RGBDCameraCalibration), so I put the .mat file generated by stereo calibration under the root directory. As a first step, run init from the root. This will update the path information and load the stereo calibration results. Then run **calib\_light\_position**, this will help you compute the center of the highlight area in each image. We will fit a line based on these centers, and trace back to z = 0, assuming it is the position of the LED light.

### step 2: analyse the raw image ###

The next step is to understand the raw image. Robert Summer has an extremely useful [document](http://users.soe.ucsc.edu/~rcsumner/rawguide/index.html) about this. In principle, please follow this document, convert your raw images to dng images, use matlab or dcraw to decode them. We modified his matlab code and wrapped it into a function read\_dng. It will return a height by width by 3 matrix within [0, 1] range after demosaicing. The data should be linear with the actual radiance.

The by-product of this project is that we have a couple of test scripts to help make sure the data in the raw image is really what we want. The first test is to decide the bayer type of the raw image. Please find red, blue and green objects, take a raw image bayer_test.dng, put it under the folder /Raw, and run **test\_bayer\_type**, this will produce four images by using all the four possible bayer types: gbrg, grbg, bggr, rggb. You can decide which is the really correct bayer type. As raw images are usually very large, no raw image samples will be provided. Feel free to contact <taodu@stanford.edu> if you cannot run the relevant script!

**test\_stability** is another test we provide in the matlab code. You can use this to decide whether the DSLR sensors provide stable results. Specifically, take three (or more) photos under same settings, put the dng images in the folder \Raw, and this script will compare them and show the absolute/relative differences.

### step 3: calibrate the light radiance ###
 
### acknowledgment and reference ###

Special thanks for Jean-Yves Bouguet's [calibration toolbox](http://www.vision.caltech.edu/bouguetj/calib_doc/).

Also, [Robert Sumner](http://users.soe.ucsc.edu/~rcsumner/index.html) has an excellent raw guide [here](http://users.soe.ucsc.edu/~rcsumner/rawguide/index.html). It is a beautiful tutorial, with very comprehensive matlab codes. We borrowed his script and made some modifications in the function read_dng.